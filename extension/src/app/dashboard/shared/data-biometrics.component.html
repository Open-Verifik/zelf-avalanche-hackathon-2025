<div class="data-biometrics-container">
	<div class="biometrics-header">
		<button class="btn-back" (click)="onBack()">
			<svg width="20" height="20" viewBox="0 0 20 20" fill="none">
				<path d="M15 10H5M5 10L10 15M5 10L10 5" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
			</svg>
			<span>{{ isDecryptMode ? "Back to " + getDataTypeTitle() + " Details" : "Back to " + getDataTypeTitle() + " Form" }}</span>
		</button>

		<h1 class="biometrics-title">{{ isDecryptMode ? "Verify Identity to Decrypt" : "Biometric Verification" }}</h1>
	</div>

	<div class="biometrics-content" fxLayout="column" fxLayoutAlign="center center">
		<div
			*ngIf="!camera.isLoading && camera.hasPermissions && !camera.isLowQuality"
			class="camera-container"
			fxLayout="column"
			fxLayoutAlign="center center"
		>
			<!-- Camera View - Much Larger Now -->
			<div class="camera-view" [style.width.px]="camera.dimensions.video.width" [style.height.px]="camera.dimensions.video.height">
				<webcam
					(imageCapture)="processImage($event)"
					(initError)="cameraError($event)"
					[allowCameraSwitch]="false"
					[captureImageData]="true"
					[height]="camera.dimensions.video.height"
					[imageQuality]="1"
					[trigger]="takePicture$"
					[videoOptions]="camera.configuration"
					[width]="camera.dimensions.video.width"
					*ngIf="!response.base64Image"
					#webcam
					mirrorImage="always"
				></webcam>

				<canvas
					[style.height.px]="response.base64Image ? camera.dimensions.result.height : camera.dimensions.video.height"
					[style.width.px]="response.base64Image ? camera.dimensions.result.width : camera.dimensions.video.width"
					#maskResult
					class="face-mask-canvas"
				></canvas>

				<canvas #toSend hidden="true"></canvas>
			</div>

			<!-- Status Messages - Positioned Below Camera -->
			<div class="status-messages" fxLayout="column" fxLayoutAlign="center center">
				<div *ngIf="errorFace && !response.isLoading" class="biometric__error">
					<div class="biometric__error-title">{{ errorFace.title }}</div>
					<div class="biometric__error-subtitle">{{ errorFace.subtitle }}</div>
				</div>

				<div *ngIf="!errorFace && !response.isLoading" class="biometric__instructions">
					<div class="biometric__instruction-title">Position your face in the center</div>
					<div class="biometric__instruction-subtitle">Look directly at the camera and stay still</div>
				</div>
			</div>

			<!-- Instructions - Compact and Strategic -->
			<div class="compact-instructions">
				<p *ngIf="!isDecryptMode">
					Please look at the camera to verify your identity and store your {{ getDataTypeTitle().toLowerCase() }} securely
				</p>
				<p *ngIf="isDecryptMode">Please look at the camera to verify your identity and decrypt your {{ getDataTypeTitle().toLowerCase() }}</p>
			</div>

			<!-- Decrypt Mode Info -->
			<div class="decrypt-info" *ngIf="isDecryptMode">
				<div class="decrypt-details">
					<strong>Decrypting:</strong> {{ getDataTypeTitle() }} with ZelfProof
					<div class="zelfproof-preview" *ngIf="itemData.zelfProof">{{ itemData.zelfProof.substring(0, 50) }}...</div>
				</div>
			</div>

			<!-- Liveness Detection Controls -->
			<div class="liveness-controls" *ngIf="!livenessDetection.isActive">
				<button class="btn-liveness" (click)="startLivenessDetection()">üîÑ Start Active Liveness Detection</button>
				<small>For enhanced security, move your face to different angles</small>
			</div>

			<!-- Liveness Detection Progress -->
			<div class="liveness-progress" *ngIf="livenessDetection.isActive">
				<h3>Active Liveness Detection</h3>
				<div class="liveness-steps">
					<div
						*ngFor="let step of livenessDetection.steps; let i = index"
						class="liveness-step"
						[class.active]="i === livenessDetection.currentStep"
						[class.completed]="step.completed"
					>
						<div class="step-indicator">
							<span *ngIf="step.completed">‚úÖ</span>
							<span *ngIf="!step.completed && i === livenessDetection.currentStep">üîÑ</span>
							<span *ngIf="!step.completed && i !== livenessDetection.currentStep">‚è≥</span>
						</div>
						<div class="step-info">
							<div class="step-name">{{ step.name }}</div>
							<div class="step-angle">{{ step.angle }}¬∞</div>
						</div>
					</div>
				</div>

				<div class="liveness-instructions" *ngIf="livenessDetection.isActive">
					<div class="current-step">
						{{ livenessDetection.steps[livenessDetection.currentStep].name }}: Turn your head
						{{
							livenessDetection.steps[livenessDetection.currentStep].angle > 0
								? "right"
								: livenessDetection.steps[livenessDetection.currentStep].angle < 0
									? "left"
									: "center"
						}}
					</div>
					<div class="hold-instruction" *ngIf="livenessDetection.isHolding">
						Hold position...
						{{ Math.ceil((livenessDetection.requiredHoldTime - (Date.now() - livenessDetection.holdStartTime)) / 1000) }}s
					</div>
				</div>
			</div>

			<!-- Optional Master Password Input -->
			<div class="password-input-container">
				<div class="password-toggle">
					<label class="form-label">Add Master Password (Optional)</label>
					<div class="toggle-switch" (click)="toggleMasterPassword()">
						<div class="toggle-slider" [class.active]="useMasterPassword"></div>
					</div>
				</div>

				<div *ngIf="useMasterPassword" class="password-input-field">
					<input
						type="password"
						id="masterPassword"
						placeholder="Enter your master password (optional)"
						[(ngModel)]="masterPassword"
						class="password-input"
					/>
					<small>Adding a master password provides additional security layer. Biometric verification is always required.</small>
				</div>
			</div>
		</div>

		<div class="loading-container" fxLayout="column" fxLayoutAlign="center center" *ngIf="response.base64Image || camera.isLoading">
			<zelf-loader [diameter]="120"></zelf-loader>
			<div *ngIf="response.isLoading" class="processing-message">Processing your biometric data...</div>
		</div>

		<div class="error-container" fxLayout="column" fxLayoutAlign="center center" *ngIf="!camera.isLoading && camera.isLowQuality">
			<img src="https://cdn.verifik.co/demo/nocameraenabled.svg" alt="Camera Error" class="camera-error-image" />
			<h2 class="error-title">Camera not available</h2>
			<p class="error-description">Please ensure your camera is enabled and accessible for biometric verification</p>
		</div>

		<div class="permission-container" fxLayout="column" fxLayoutAlign="center center" *ngIf="!camera.isLoading && !camera.hasPermissions">
			<div class="permission-icon">üì∑</div>
			<h2 class="permission-title">Camera Permission Required</h2>
			<p class="permission-description">Please allow camera access to continue with biometric verification</p>
			<button class="btn-retry" (click)="onBack()">Go Back</button>
		</div>
	</div>
</div>
